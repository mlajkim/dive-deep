name: Auto Manage PR State

on:
  pull_request:
    types: [ opened, edited, reopened, synchronize, ready_for_review, converted_to_draft ]

permissions:
  pull-requests: write

jobs:
  manage-pr-state:
    runs-on: ubuntu-latest
    steps:
    - name: Update PR State based on Checklist
      uses: actions/github-script@v6
      with:
        script: |
          const pr = context.payload.pull_request;
          const body = pr.body || "";
          const isDraft = pr.draft;
          const nodeId = pr.node_id; // ID for GraphQL

          // Get list of checklist items
          const hasUnchecked = /-\s\[\s*\]/.test(body);

          // If there are unchecked items and PR is not Draft -> convert to Draft
          if (hasUnchecked && !isDraft) {
            console.log("üöß Unchecked items found. Converting to Draft...");
            const mutation = `
              mutation($id: ID!) {
                convertPullRequestToDraft(input: {pullRequestId: $id}) {
                  pullRequest { isDraft }
                }
              }
            `;
            await github.graphql(mutation, { id: nodeId });
            core.info("‚úÖ Converted to Draft.");
          }

          // If everything is checked and it's Draft -> Ready for Review
          else if (!hasUnchecked && isDraft) {
            console.log("‚ú® All items checked. Marking as Ready for Review...");
            const mutation = `
              mutation($id: ID!) {
                markPullRequestReadyForReview(input: {pullRequestId: $id}) {
                  pullRequest { isDraft }
                }
              }
            `;
            await github.graphql(mutation, { id: nodeId });
            core.info("‚úÖ Marked as Ready for Review.");
          }

          // No state change needed:
          else {
            console.log(`‚ÑπÔ∏è No state change needed. (Has Unchecked: ${hasUnchecked}, Is Draft: ${isDraft})`);
          }

